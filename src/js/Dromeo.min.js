/**
*
*   Dromeo
*   Simple and Flexible Pattern Routing Framework for PHP, JavaScript, Python
*   @version: 1.3.0
*
*   https://github.com/foo123/Dromeo
*
**/
!function(e,n,t){"use strict";var r;"undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils.import?(e.EXPORTED_SYMBOLS=[n],e[n]=t.call(e)):"object"==typeof module&&module.exports?module.exports=t.call(e):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(n)?define(n,["require","exports","module"],function(){return t.call(e)}):n in e||(e[n]=r=t.call(e))&&"function"==typeof define&&define.amd&&define(function(){return r})}("undefined"!=typeof self?self:this,"Dromeo",function(I){"use strict";var v=/^([^|]+\|.+)$/,T=/\((\d+)\)$/,n=/^\s+|\s+$/g,t=/([*+\[\]\(\)?^$\/\\:.])/g,e="prototype",r=Object[e],i=(Array[e],Function[e],r.toString),j=r.hasOwnProperty,A=("undefined"!=typeof global&&i.call(global),String[e].trim?function(e){return e.trim()}:function(e){return e.replace(n,"")}),o={php:/^(?:([^:\/?#]+):)?(?:\/\/()(?:(?:()(?:([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?()(?:(()(?:(?:[^?#\/]*\/)*)()(?:[^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/\/?)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},s=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"];function N(e){return 0<e.length}function x(e){return e.replace(t,"\\$1")}function O(e){return"[object Array]"===i.call(e)}function y(e){return"[object Object]"===i.call(e)&&"function"==typeof e.constructor&&"Object"===e.constructor.name}function h(e){return"string"==typeof e||"[object String]"===i.call(e)}function p(e){return"function"==typeof e}function b(e,n,t){var r,l,u;if(t=!0===t,n)for(r in n)j.call(n,r)&&(l=n[r],"number"==typeof(u=l)||"[object Number]"===i.call(u)?e[r]=0+l:h(l)?e[r]=l.slice():O(l)?e[r]=t?b(new Array(l.length),l,t):l:y(l)?e[r]=t?b({},l,t):l:e[r]=l);return e}function P(e){return decodeURIComponent(String(e))}function a(e){return encodeURIComponent(String(e)).split("!").join("%21").split("'").join("%27").split("(").join("%28").split(")").join("%29").split("*").join("%2A")}function f(e){return a(e).split("%20").join("+")}function l(e){for(var n,t,r,l,u,i,o,s,a,f,c,h,p=e.replace(/^&+|&+$/g,"").split("&"),d=p.length,g={},_=[],m=0;m<d;++m)if(i=p[m].split("="),u=P(A(i[0])),i=i.length<2?"":P(A(i[1])),(u=-1<(n=u.indexOf("\0"))?u.slice(0,n):u)&&"["!==u.charAt(0)){for(s=[],n=o=0;n<u.length;++n)if("["!==u.charAt(n)||o){if("]"===u.charAt(n)&&o&&(s.length||s.push(u.slice(0,o-1)),s.push(u.substr(o,n-o)),o=0,"["!==u.charAt(n+1)))break}else o=n+1;for(s.length||(s=[u]),n=0;n<s[0].length&&(" "!==(l=s[0].charAt(n))&&"."!==l&&"["!==l||(s[0]=s[0].substr(0,n)+"_"+s[0].substr(n+1)),"["!==l);++n);for(u=null,t=r=g,f=s.length?A(s[s.length-1].replace(/^['"]|['"]$/g,"")):null,n=0,a=s.length;n<a;++n)c=u,u=s[n].replace(/^['"]|['"]$/g,""),h=t,t=r,""!==A(u)||0===n?(j.call(r,u)||(r[u]=n+1===a-1&&""===f?[]:{}),r=r[u]):u=!0;!0===u?t.push(i):(u==+u&&_.push({key:c,obj:h}),t[u]=i)}for(m=_.length-1;0<=m;--m)!function(e){if(O(e))return 1;if(y(e)){var n,t=function(e){if("function"==typeof Object.keys)return Object.keys(e);var n,t,r;if(O(e))for(n=new Array(r=e.length),t=0;t<r;++t)n[t]=String(t);else for(t in n=[],e)j.call(e,t)&&n.push(t);return n}(e),r=t.length;for(n=0;n<r;++n)if(n!==+t[n])return;return 1}return}(r=_[m].key?_[m].obj[_[m].key]:_[m].obj)||(r=function(e){if(O(e))return e;if("function"==typeof Object.values)return Object.values(e);var n,t=[];for(n in e)j.call(e,n)&&t.push(e[n]);return t}(r),_[m].key?_[m].obj[_[m].key]=r:g=r);return g}function u(e,n,t){var r,l=n.length;if(!0===t)return 0<l&&-1!==n.indexOf(e);for(r=0;r<l;++r)if(e==n[r])return 1}function c(e,n,t){var r,l,u=[];for(r in arguments.length<2&&(n="&"),arguments.length<3&&(t=!1),e)j.call(e,r)&&""!=(l=function e(n,t,r,l){var u,i,o=l?a:f;if(!0===t?t="1":!1===t&&(t="0"),null==t)return"";if("object"!=typeof t)return o(n)+"="+o(t);for(u in i=[],t)j.call(t,u)&&null!=t[u]&&i.push(e(n+"["+u+"]",t[u],r,l));return i.join(r)}(r,e[r],n,t))&&u.push(l);return u.join(n)}function Y(e,n,t){if(n!==t&&t){var r,l,u=[];for(e=e.split(n),l=0;l<e.length;++l)r=(r=e[l]).split(t),u.push(r[0]),1<r.length&&u.push(r[1]);return u}return e.split(n)}function D(n){return function(e){return n}}function C(n){return function(e){return e[n]?e[n].length:0}}function d(e,n,t,r,l){var u,i,o,s,a,f,c,h,p,d,g,_,m,y,P,b,S,E,k,R;if(t.indexOf(e[0])<0)return[t,l&&l.length?l+t:t,{},r,!0,[t]];for(s=(u=Y(t,e[0],e[1])).length,c=!1,h="",E=[],d=S=0,_={},b=[],l&&l.length&&(h+=x(l),S=l.length),o=0;o<s;++o)i=u[o],c=c?(f=a=!1,g=null,k=[],p=i.split(e[4]),A(p[0]).length||(p[0]=e[2]+"PART"+e[3]),y=function(e,n,t){for(var r,l,u,i=0,o={},s=[],a=[],f=null,c=(t=Y(t,e[2],e[3])).length,h=!(l=[]),p=0;p<c;++p)h=h?(t[p].length&&(j.call(n,t[p])?(s.push("("+n[t[p]][0]+")"),++i,n[t[p]][1]&&(o[i]=n[t[p]][1]),null==f&&(f=s[s.length-1]),l.push([i])):(r=t[p].match(v))?(s.push("("+r[1].split("|").filter(N).map(x).join("|")+")"),null==f&&(f=s[s.length-1]),l.push([++i])):t[p].length&&(s.push("("+x(t[p])+")"),null==f&&(f=s[s.length-1]),l.push([++i]))),a.push(!0),!1):(t[p].length&&(s.push(x(t[p])),a.push(t[p]),l.push(t[p].length)),!0);return 1===s.length&&1===i?(o[0]=o[1]||null,[u=s.join(""),i,o,a,f||u,l]):(o[0]=null,[u="("+s.join("")+")",i+1,o,a,f||u,l])}(e,n,p[0]),1<p.length&&((p=(m=(a=(m=A(p[1])).length&&"?"===m.charAt(0))?m.slice(1):m).match(T))?(m=m.slice(0,-p[0].length),P=parseInt(p[1],10),g=j.call(y[2],P)?y[2][P]:null,0<P&&P<y[1]?(R=!1,k=y[5].reduce(function(e,n){return(R=O(n)&&n[0]>=P?!0:R)||e.push(O(n)?C(n[0]+d+1):D(n)),e},[]),P+=d+1):P=d+1):(g=y[2][0]||null,P=d+1),f=0<m.length),h+=y[0],a&&(h+="?"),f&&(_[m]=[P,g,function(e){return function(t){return e.reduce(function(e,n){return e+n(t)},0)}}(E.concat(k))]),f&&b.push({name:m,optional:a,re:new RegExp("^"+y[4]+"$"),tpl:y[3]}),S=0,E.push(C(d+1)),d+=y[1],!1):(h+=x(i),S+=i.length,b.push(i),E.push(D(S)),!0);return[t,new RegExp("^"+h+"$"),_,r,!1,b]}function g(e,n){return n.join(",")+"->"+e}function _(e){return(e=u("*",e=e?e.map?e.map(function(e){return e.toLowerCase()}):[String(e).toLowerCase()]:["*"])?["*"]:e).sort(),e}function m(e,n,t){if(n&&h(n.route)&&n.handler&&p(n.handler)){t=!0===t;for(var r=n.handler,l=n.defaults||{},u=n.types||null,i=n.name||null,o=_(n.method),s=g(n=e.key+n.route,o),a=null,f=0,c=e._routes.length;f<c;++f)if(s===e._routes[f].key){a=e._routes[f];break}a||(a=new k(e._delims,e._patterns,n,o,i,e._prefix),e._routes.push(a),e._addNamedRoute(a)),a.handlers.push([r,l,u,t,0])}}function S(e,n){for(var t,r=e._routes.length-1;0<=r;--r)n===e._routes[r].key&&(t=e._routes[r],e._routes.splice(r,1),e._delNamedRoute(t),t.dispose())}function E(e){Error.call(this,e),this.name="DromeoException"}function k(e,n,t,r,l,u){var i=this;i.__args__=[e,n],i.isParsed=!1,i.handlers=[],i.route=null!=t?String(t):"",i.prefix=null!=u?String(u):"",i.method=r,i.pattern=null,i.captures=null,i.literal=!1,i.namespace=null,i.tpl=null,i.name=null!=l?String(l):null,i.key=g(i.route,i.method)}function R(e,n,t){var r=this;if(!(r instanceof R))return new R(e,n,t);r._delims=["{","}","%","%",":"],r._patterns={},r.definePattern("ALPHA","[a-zA-Z\\-_]+"),r.definePattern("ALNUM","[a-zA-Z0-9\\-_]+"),r.definePattern("ASCII","[ -~]+"),r.definePattern("NUMBR","[0-9]+"),r.definePattern("INT","[0-9]+","INT"),r.definePattern("PART","[^\\/?#]+"),r.definePattern("VAR","[^=?&#\\/]+","VAR"),r.definePattern("QUERY","\\?[^?#]+"),r.definePattern("FRAGMENT","#[^?#]+"),r.definePattern("URLENCODED","[^\\/?#]+","URLENCODED"),r.definePattern("ALL",".+"),r.definePattern("ANY","[\\s\\S]+"),r._routes=[],r._named_routes={},r._fallback=!1,r._top=t instanceof R?t:r,r.key=r===r._top?"":r._top.key+String(n),r._prefix=null==e?"":String(e)}return(E[e]=Object.create(Error[e])).constructor=E,k.to_key=g,k[e]={constructor:k,__args__:null,isParsed:!1,handlers:null,route:null,prefix:null,pattern:null,captures:null,tpl:null,method:null,literal:null,namespace:null,name:null,key:null,dispose:function(){var e=this;return e.__args__=null,e.isParsed=null,e.handlers=null,e.route=null,e.prefix=null,e.pattern=null,e.captures=null,e.tpl=null,e.method=null,e.literal=null,e.namespace=null,e.name=null,e.key=null,e},parse:function(){var e,n=this;return n.isParsed||(e=d(n.__args__[0],n.__args__[1],n.route,n.method,n.prefix),n.pattern=e[1],n.captures=e[2],n.tpl=e[5],n.literal=!0===e[4],n.__args__=null,n.isParsed=!0),n},match:function(e,n){var t=this;return u(n=n||"*",t.method)||"*"===t.method[0]?(t.isParsed||t.parse(),e=String(e),t.literal?e===t.pattern?[]:null:e.match(t.pattern)):null},make:function(e,n){var t,r,l,u,i,o,s,a,f=this,c="";for(e=e||{},n=!0===n,f.isParsed||f.parse(),t=0,r=(a=f.tpl).length;t<r;++t)if(h(a[t]))c+=a[t];else if(j.call(e,a[t].name)&&null!=e[a[t].name]){if(o=(o=O(o=e[a[t].name])?o:[o]).map(String),n&&!a[t].re.test(o[0]))throw new E('Dromeo: Route "'+f.name+'" (Pattern: "'+f.route+'") parameter "'+a[t].name+'" value "'+o[0]+'" does not match pattern!');for(i=l=0,u=(s=a[t].tpl).length;l<u;++l)!0===s[l]?(c+=i<o.length?o[i]:o[0],++i):c+=s[l]}else if(!a[t].optional)throw new E('Dromeo: Route "'+f.name+'" (Pattern: "'+f.route+'") missing parameter "'+a[t].name+'"!');return c},sub:function(e,n,t,r){var l,u,i,o,s,a,f,c=this;if(c.isParsed&&!c.literal)for(l in i=e[0],o=p(r),c.captures)j.call(c.captures,l)&&(s=(a=c.captures[l])[0],u=a[1],a=a[2],e[s]?(s=e[s],a=o?(a=a(e),String(r(l,s,a,a+s.length,i))):s,t&&j.call(t,l)&&t[l]?(h(f=t[l])&&j.call(R.TYPES,f)&&(f=R.TYPES[f]),n[l]=p(f)?f(a):a):n[l]=u&&p(f=u)?f(a):a):j.call(n,l)||(n[l]=null));return c}},R.VERSION="1.3.0",R.Exception=E,R.Route=k,R.to_method=_,(R.TYPES={INTEGER:function(e){return parseInt(e,10)||0},STRING:function(e){return h(e)?e:""+String(e)},URLDECODE:function(e){return P(String(e).split("+").join("%20"))},ARRAY:function(e){return O(e)?e:[e]},PARAMS:function(e){return h(e)?R.unglue_params(e):e}}).INT=R.TYPES.INTEGER,R.TYPES.STR=R.TYPES.STRING,R.TYPES.VAR=R.TYPES.URLDECODE,R.TYPES.URLENCODED=R.TYPES.PARAMS,R.glue_params=function(e){var n="";return e&&(n+=c(e,"&",!0)),n},R.unglue_params=function(e){return e?l(e):{}},R.parse_components=function(e,n,t){var r={};return e&&((arguments.length<3||null==t)&&(t="fragment_params"),(arguments.length<2||null==n)&&(n="query_params"),r=function(e,n,t){for(var r=o[t||"php"].exec(e),l={},u=14;u--;)r[u]&&(l[s[u]]=r[u]);return j.call(l,"port")&&(l.port=parseInt(l.port,10)),n?l[n.replace("PHP_URL_","").toLowerCase()]||null:(l.source&&delete l.source,l)}(e),n&&(r.query?r[n]=this.unglue_params(r.query):r[n]={}),t)&&(r.fragment?r[t]=this.unglue_params(r.fragment):r[t]={}),r},R.build_components=function(e,n,t,r,l){e=""+e;return(arguments.length<5||null==l)&&(l="#"),(arguments.length<4||null==r)&&(r="?"),n&&(e+=r+this.glue_params(n)),t&&(e+=l+this.glue_params(t)),e},R.defType=function(e,n){e&&p(n)&&(R.TYPES[e]=n)},R.TYPE=function(e){return e&&j.call(R.TYPES,e)?R.TYPES[e]:null},R[e]={constructor:R,_delims:null,_patterns:null,_routes:null,_named_routes:null,_fallback:!1,_prefix:"",_top:null,key:"",dispose:function(){var e,n,t=this;if(t._top=null,t._delims=null,t._patterns=null,t._fallback=null,t._prefix=null,t._routes)for(e=0,n=t._routes.length;e<n;++e)t._routes[e].dispose();return t._routes=null,t._named_routes=null,t},top:function(){return this._top},isTop:function(){return null==this._top||this===this._top},clone:function(e){var n,t,r=this,l=new R(r._prefix,e,r);for(n in l.defineDelimiters(r._delims),r._patterns)j.call(r._patterns,n)&&(t=r._patterns[n],l.definePattern(n,t[0],1<t.length?t[1]:null));return l},reset:function(){return this._routes=[],this._named_routes={},this._fallback=!1,this},defineDelimiters:function(e){var n,t=this._delims;return e&&(0<(n=e.length)&&e[0]&&(t[0]=e[0]),1<n&&e[1]&&(t[1]=e[1]),2<n&&e[2]&&(t[2]=e[2]),3<n&&e[3]&&(t[3]=e[3]),4<n)&&e[4]&&(t[4]=e[4]),this},definePattern:function(e,n,t){return(t=t&&h(t)&&t.length&&j.call(R.TYPES,t)?R.TYPES[t]:t)&&p(t)||(t=null),this._patterns[e]=[n,t],this},dropPattern:function(e){var n=this._patterns;return j.call(n,e)&&delete n[e],this},defineType:function(e,n){return R.defType(e,n),this},glue:function(e){return R.glue_params(e)},unglue:function(e){return R.unglue_params(e)},parse:function(e,n,t){return R.parse_components(e,n,t)},build:function(e,n,t,r,l){return R.build_components(e,n,t,r,l)},onGroup:function(e,n){return(e=String(e)).length&&p(n)&&(e=this.clone(e),this._routes.push(e),n(e)),this},on:function(){for(var e=arguments,n=e.length,t=1===n?O(e[0])?e[0]:[e[0]]:2===n&&h(e[0])&&p(e[1])?[{route:e[0],handler:e[1],method:"*",defaults:{},types:null}]:e,r=0,l=t.length;r<l;++r)m(this,t[r],!1);return this},one:function(){for(var e=arguments,n=e.length,t=1===n?O(e[0])?e[0]:[e[0]]:2===n&&h(e[0])&&p(e[1])?[{route:e[0],handler:e[1],method:"*",defaults:{},types:null}]:e,r=0,l=t.length;r<l;++r)m(this,t[r],!0);return this},off:function(e,n,t){var r,l,u,i,o=this,s=o._routes;if(e)if(null==t&&(t="*"),y(e)){if(n=e.handler||n,t=e.method||t,!(e=e.route))return o;for(i=g(e=String(e),_(t)),l=null,r=0,u=s.length;r<u;++r)if(s[r]instanceof R)s[r].off(e,n,t);else if(i===s[r].key){l=s[r];break}if(!l)return o;if(n&&p(n)){for(r=(u=l.handlers.length)-1;0<=r;--r)n===l.handlers[r][0]&&l.handlers.splice(r,1);l.handlers.length||S(o,i)}else S(o,i)}else if(h(e)&&e.length){for(i=g(e=String(e),_(t)),l=null,r=0,u=s.length;r<u;++r)if(s[r]instanceof R){if(e===s[r].key){l=s[r];break}s[r].off(e,n,t)}else if(i===s[r].key){l=s[r];break}if(!l)return o;if(l instanceof R)s.splice(r,1),l.dispose();else if(n&&p(n)){for(r=(u=l.handlers.length)-1;0<=r;--r)n===l.handlers[r][0]&&l.handlers.splice(r,1);l.handlers.length||S(o,i)}else S(o,i)}return o},fallback:function(e){return!1!==(e=arguments.length<1?!1:e)&&null!==e&&!p(e)||(this._fallback=e),this},make:function(e,n,t){var r=this._named_routes;return j.call(r,e)?r[e].make(n,t):null},route:function(e,n,t,r){var l,u,i,o,s,a,f,c,h,p,d,g,_,m,y,P=this;if(P.isTop()||P._routes.length){if(y=!(l=!0),e=null!=e?String(e):"",l=(u=P._prefix+P.key).length?u===e.slice(0,u.length):l){for(t=!1!==t,n=null!=n?String(n).toLowerCase():"*",h=(i=P._routes.slice()).length,c=0;c<h;++c){if((o=i[c])instanceof R){if(!(g=o.route(e,n,t,r)))continue;y=!0}else{if(null==(g=o.match(e,n)))continue;for(y=!0,f=[],p=(_=o.handlers.slice()).length,d=0;d<p;++d)(m=_[d])[3]&&m[4]?f.unshift(d):(s=m[1],a=m[2],s={route:e,method:n,pattern:o.route,fallback:!1,data:b({},s,!0)},o.sub(g,s.data,a,r),m[4]=1,m[3]&&f.unshift(d),m[0](s));for(d=0,p=f.length;d<p;++d)o.handlers.splice(f[d],1);o.handlers.length||S(P,o.key)}if(t)return!0}if(y)return!0}P._fallback&&P.isTop()&&P._fallback({route:e,method:n,pattern:null,fallback:!0,data:null})}return!1},_addNamedRoute:function(e){return this.isTop()?e instanceof R.Route&&e.name&&e.name.length&&(this._named_routes[e.name]=e):this.top()._addNamedRoute(e),this},_delNamedRoute:function(e){var n=this;return n.isTop()?e instanceof R.Route&&e.name&&j.call(n._named_routes,e.name)&&delete n._named_routes[e.name]:n.top()._delNamedRoute(e),n}},R});